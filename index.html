<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSSE 11+ English Comprehension Test Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for a nice font and colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'csse-blue': '#1e3a8a', // Dark blue
                        'csse-light': '#eff6ff', // Light blue background
                        'csse-accent': '#f59e0b', // Amber/Orange accent
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* General box styling */
        .test-box {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-csse-light font-sans antialiased min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center py-6 mb-8 bg-csse-blue text-white rounded-xl test-box">
            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">CSSE 11+ Comprehension Practice</h1>
            <p class="mt-1 text-csse-light">Powered by AI Passage and Question Generation</p>
        </header>

        <!-- Loading / Generator Section -->
        <div id="loading-container" class="test-box bg-white p-6 rounded-xl text-center flex flex-col items-center justify-center min-h-64 transition-opacity duration-500 ease-in-out">
            <h2 id="loading-text" class="text-2xl font-semibold text-csse-blue mb-4">Generating Your Practice Test...</h2>
            <div id="spinner" class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-csse-accent border-t-csse-blue mb-4"></div>
            <p class="text-gray-500">Please wait while the AI crafts a new passage and questions.</p>
        </div>

        <!-- Error Container -->
        <div id="error-container" class="hidden test-box bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-xl mb-6" role="alert">
            <p class="font-bold">Error Generating Content</p>
            <p id="error-message">A communication error occurred. Please try again.</p>
        </div>

        <!-- Test Content Section -->
        <div id="test-container" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Passage Column (Always 1/3) -->
            <div class="lg:col-span-1 test-box bg-white p-6 rounded-xl h-full lg:sticky lg:top-8" style="max-height: calc(100vh - 4rem);">
                <h2 class="text-xl font-bold text-csse-blue border-b pb-2 mb-4">Comprehension Passage</h2>
                <div id="passage-content" class="text-gray-700 space-y-4 overflow-y-auto pr-2 h-full">
                    <!-- Passage content will be inserted here -->
                </div>
            </div>

            <!-- Questions Column (Always 2/3) -->
            <div class="lg:col-span-2 test-box bg-white p-6 rounded-xl">
                <h2 class="text-xl font-bold text-csse-blue border-b pb-2 mb-4 flex justify-between items-center">
                    Questions (Total: <span id="question-count">0</span>)
                    <button id="regenerate-btn" class="bg-csse-accent text-white px-3 py-1 text-sm font-semibold rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md">
                        Generate New Test
                    </button>
                </h2>

                <div id="questions-list" class="space-y-6">
                    <!-- Questions will be inserted here -->
                </div>

                <!-- Submit Button -->
                <button id="submit-btn" class="mt-8 w-full bg-green-600 text-white py-3 rounded-lg text-lg font-bold hover:bg-green-700 transition duration-150 shadow-lg">
                    Check Answers
                </button>

                <!-- Score / Review Section -->
                <div id="results-container" class="hidden mt-8 p-6 bg-csse-light border-2 border-csse-blue rounded-xl">
                    <h3 class="text-2xl font-bold text-csse-blue mb-4">Test Results</h3>
                    <p id="score-text" class="text-xl font-semibold mb-4"></p>
                    <button id="review-btn" class="bg-csse-blue text-white px-4 py-2 rounded-lg hover:bg-csse-blue/90 transition duration-150">
                        Review Answers & Explanations
                    </button>
                    <button id="start-new-btn" class="ml-4 bg-csse-accent text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition duration-150">
                        Start New Test
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        // Global environment variables (provided by the execution environment)
        const apiKey = "";
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=" + apiKey;

        // --- DOM Elements ---
        const app = document.getElementById('app');
        const loadingContainer = document.getElementById('loading-container');
        const testContainer = document.getElementById('test-container');
        const passageContent = document.getElementById('passage-content');
        const questionsList = document.getElementById('questions-list');
        const submitBtn = document.getElementById('submit-btn');
        const resultsContainer = document.getElementById('results-container');
        const scoreText = document.getElementById('score-text');
        const reviewBtn = document.getElementById('review-btn');
        const startNewBtn = document.getElementById('start-new-btn');
        const regenerateBtn = document.getElementById('regenerate-btn');
        const questionCountSpan = document.getElementById('question-count');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');

        // --- State Management ---
        let testData = null; // Stores the generated passage and questions
        let userAnswers = {}; // { questionIndex: selectedOptionText }
        let isReviewMode = false;

        // --- Core Application Logic ---

        /**
         * Hides or shows the loading state and test content.
         * @param {boolean} isLoading
         */
        function toggleLoading(isLoading) {
            if (isLoading) {
                loadingContainer.classList.remove('hidden');
                testContainer.classList.add('hidden');
                errorContainer.classList.add('hidden');
            } else {
                loadingContainer.classList.add('hidden');
                testContainer.classList.remove('hidden');
            }
        }

        /**
         * Shows an error message.
         * @param {string} message
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            loadingContainer.classList.add('hidden');
            testContainer.classList.add('hidden');
        }

        /**
         * Calls the Gemini API to generate the comprehension test content.
         */
        async function generateTestContent() {
            toggleLoading(true);
            testData = null;
            userAnswers = {};
            isReviewMode = false;
            hideResults();
            questionsList.innerHTML = '';
            passageContent.innerHTML = '';

            const systemInstruction = `You are a test content generator for the CSSE 11+ English Comprehension exam.
            Your task is to generate a realistic, challenging, and age-appropriate comprehension passage (around 300-400 words) and exactly 5 multiple-choice questions based *only* on the passage.

            The passage should be engaging, descriptive, and focus on narrative or descriptive elements typical of 11+ exams, for example, a historical setting, an adventure, or an intriguing character.

            The 5 questions must cover the following skills:
            1. Vocabulary in context (finding the meaning of a word used in the passage).
            2. Inferential comprehension (deducing meaning or implication not explicitly stated).
            3. Literal recall/fact retrieval (finding a directly stated fact).
            4. Understanding authorial intent or tone (why the author used certain language).
            5. Analysis of structural features or figurative language (e.g., simile, metaphor).

            The response must be a single JSON object conforming to the provided schema. Ensure there are exactly 5 questions and each question has exactly 4 options. The rationale for the correct answer should be specific and link directly to the text.`;

            const userQuery = "Generate a new comprehension passage and 5 multiple-choice questions suitable for a CSSE 11+ English practice test.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            passage: { type: "STRING", description: "The full comprehension passage text." },
                            questions: {
                                type: "ARRAY",
                                description: "An array of 5 multiple-choice questions.",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        questionText: { type: "STRING" },
                                        options: {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: {
                                                    text: { type: "STRING" },
                                                    isCorrect: { type: "BOOLEAN" },
                                                    rationale: { type: "STRING", description: "Brief explanation (1-2 sentences) for why this option is correct or incorrect, specifically referencing the passage." }
                                                }
                                            }
                                        }
                                    },
                                    required: ["questionText", "options"]
                                }
                            }
                        },
                        required: ["passage", "questions"]
                    }
                }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                const textPart = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!textPart) {
                    throw new Error("Received an empty response from the API.");
                }

                const parsedData = JSON.parse(textPart);
                if (!parsedData.passage || !parsedData.questions || parsedData.questions.length !== 5) {
                    throw new Error("Incomplete or malformed data structure received from the API.");
                }

                testData = parsedData;
                renderTest();

            } catch (error) {
                console.error("Test generation failed:", error);
                showError("The test could not be generated. Details: " + error.message);
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * Renders the passage and questions to the DOM.
         */
        function renderTest() {
            if (!testData) return;

            // 1. Render Passage
            passageContent.innerHTML = testData.passage
                .split('\n')
                .map(p => p.trim())
                .filter(p => p.length > 0)
                .map(p => `<p>${p}</p>`).join('');

            // 2. Render Questions
            questionsList.innerHTML = '';
            questionCountSpan.textContent = testData.questions.length;

            testData.questions.forEach((q, index) => {
                const qElement = document.createElement('div');
                qElement.id = `q-${index}`;
                qElement.className = 'p-4 border border-gray-200 rounded-lg bg-gray-50 transition duration-150';
                
                let optionsHtml = q.options.map((option, optIndex) => {
                    const optionId = `q${index}-opt${optIndex}`;
                    const isSelected = userAnswers[index] === option.text;
                    const isCorrect = option.isCorrect;

                    let classes = "group flex items-center p-3 rounded-lg cursor-pointer transition duration-150 ease-in-out border hover:bg-csse-light";

                    if (isReviewMode) {
                        if (isCorrect) {
                            // Correct answer in review mode
                            classes += " border-green-500 bg-green-50";
                        } else if (isSelected && !isCorrect) {
                            // User selected wrong answer in review mode
                            classes += " border-red-500 bg-red-50";
                        } else {
                            // Unselected wrong answer in review mode
                            classes += " border-gray-200";
                        }
                    } else {
                        // Regular selection mode
                        classes += isSelected ? " border-csse-accent bg-yellow-50 shadow-md" : " border-gray-200";
                    }

                    return `
                        <label for="${optionId}" class="${classes}">
                            <input type="${isReviewMode ? 'hidden' : 'radio'}" id="${optionId}" name="question-${index}" value="${option.text}"
                                class="h-4 w-4 text-csse-blue focus:ring-csse-blue mr-3"
                                ${isSelected ? 'checked' : ''}
                                ${isReviewMode ? 'disabled' : ''}
                                data-question-index="${index}"
                                data-option-text="${option.text}"
                                onchange="handleAnswerChange(this)">
                            <span class="text-gray-800 font-medium">${String.fromCharCode(65 + optIndex)}. ${option.text}</span>
                        </label>
                        ${isReviewMode && (isCorrect || (isSelected && !isCorrect)) ?
                            `<div class="mt-2 text-sm p-3 rounded-lg ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                <span class="font-bold">${isCorrect ? 'Correct:' : 'Incorrect:'}</span> ${option.rationale}
                            </div>`
                            : ''
                        }
                    `;
                }).join('');

                qElement.innerHTML = `
                    <p class="font-semibold text-gray-900 mb-3">Q${index + 1}: ${q.questionText}</p>
                    <div class="space-y-2">
                        ${optionsHtml}
                    </div>
                `;
                questionsList.appendChild(qElement);
            });

            // Update button visibility
            submitBtn.classList.remove('hidden');
            if (isReviewMode) {
                submitBtn.classList.add('hidden');
            } else {
                resultsContainer.classList.add('hidden');
            }
        }

        // Expose a global function for the radio button onchange event
        window.handleAnswerChange = (radio) => {
            const index = radio.getAttribute('data-question-index');
            const text = radio.getAttribute('data-option-text');
            userAnswers[index] = text;
        };

        /**
         * Calculates the score and switches to results mode.
         */
        function checkAnswers() {
            if (!testData) return;

            const totalQuestions = testData.questions.length;
            let correctCount = 0;

            testData.questions.forEach((q, index) => {
                const correctAnswer = q.options.find(opt => opt.isCorrect);
                if (correctAnswer && userAnswers[index] === correctAnswer.text) {
                    correctCount++;
                }
            });

            scoreText.innerHTML = `You scored <span class="text-3xl font-extrabold text-csse-blue">${correctCount} / ${totalQuestions}</span> (${Math.round((correctCount / totalQuestions) * 100)}%).`;
            showResults();
        }

        /**
         * Shows the results container and sets up the review mode.
         */
        function showResults() {
            resultsContainer.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        }

        /**
         * Hides the results container.
         */
        function hideResults() {
            resultsContainer.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            isReviewMode = false;
        }

        /**
         * Toggles the review mode on/off.
         */
        function toggleReviewMode() {
            isReviewMode = !isReviewMode;
            if (isReviewMode) {
                reviewBtn.textContent = 'Hide Review';
            } else {
                reviewBtn.textContent = 'Review Answers & Explanations';
            }
            renderTest(); // Re-render questions with feedback
        }

        // --- Event Listeners ---
        submitBtn.addEventListener('click', checkAnswers);
        reviewBtn.addEventListener('click', toggleReviewMode);
        startNewBtn.addEventListener('click', generateTestContent);
        regenerateBtn.addEventListener('click', generateTestContent);

        // --- Initialization ---
        window.onload = generateTestContent;

    </script>
</body>
</html>
